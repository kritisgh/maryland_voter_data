<!doctype html>
<html lang="en">

<head>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="/static/general_style.css">
    <link rel="stylesheet" href="/static/eligible_inactive.css">
    <link rel="stylesheet" href="//cdn.datatables.net/2.0.0/css/dataTables.dataTables.min.css" />
    <script src="//cdn.datatables.net/2.0.0/js/dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <span style="font-size:30px;cursor:pointer" onclick="openNav()">&#9776; Menu</span>

    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <a href="#">Home</a>
        <a href="official-turnout">Official Maryland Turnout</a>
        <a href="eligible-active">Eligible Active Voters</a>
        <a href="eligible-inactive">Eligible Inactive Voters</a>
    </div>

    <h1>Maryland Voter Turnout Data - Eligible Active Voters</h1>

    <div class="chart-container">
        <h3>Turnout by County</h3>
        <div class="graph-filter">
            <label for="county-graph-filter"><strong>Select County:</strong></label>
            <select id="county-graph-filter">
                <option value="all">All Counties</option>
            </select>
        </div>
        <br>
        <canvas id="turnout-chart"></canvas>
    </div>

    <div class="controls">
        <div class="filter-group">
            <label for="county-filter">Filter by County:</label>
            <select id="county-filter">
                <option value="all">All Counties</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="party-filter">Filter by Party:</label>
            <select id="party-filter">
                <option value="none">All Parties</option>
                <option value="Democrat">Democrat</option>
                <option value="Republican">Republican</option>
                <option value="Green">Green</option>
                <option value="Libertarian">Libertarian</option>
                <option value="Unaffiliated">Unaffiliated</option>
                <option value="Other">Other</option>
            </select>
        </div>

        <button id="reset-filters">Reset Filters</button>
    </div>

    <table id="voter-data" border=1 cellpadding=7>
        <thead>
            <tr>
                <th>County</th>
                <th>Democrat</th>
                <th>Republican</th>
                <th>Green</th>
                <th>Libertarian</th>
                <th>Unaffiliated</th>
                <th>Other</th>
            </tr>
        </thead>
        <tbody>
            {% for obj in object_list %}
            <tr>
                <td>{{ obj.county }}</td>
                <td>{{ "{:,}".format(obj.democrat_diff) }}</td>
                <td>{{ "{:,}".format(obj.republican_diff) }}</td>
                <td>{{ "{:,}".format(obj.green_diff) }}</td>
                <td>{{ "{:,}".format(obj.libertarian_diff) }}</td>
                <td>{{ "{:,}".format(obj.unaffiliated_diff) }}</td>
                <td>{{ "{:,}".format(obj.other_diff) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script type="text/javascript">
        $('#voter-data').DataTable({
            paging: true,
            searching: false,
            autoWidth: false,
            columnDefs: [
                { targets: 'no-sort', orderable: false }
            ]
        });
    </script>

    <script>
        function openNav() {
            document.getElementById("mySidenav").style.width = "250px";
        }

        function closeNav() {
            document.getElementById("mySidenav").style.width = "0";
        }

        document.addEventListener('DOMContentLoaded', function () {
            const table = $('#voter-data').DataTable(); // DataTable instance

            const countyFilter = document.getElementById('county-filter');
            const partyFilter = document.getElementById('party-filter');
            const resetButton = document.getElementById('reset-filters');
            const graphCountyFilter = document.getElementById('county-graph-filter');

            const uniqueCounties = new Set();
            table.rows().every(function () {
                const data = this.data();
                uniqueCounties.add(data[0]); // County
            });

            Array.from(uniqueCounties).sort().forEach(county => {
                const opt1 = document.createElement('option');
                opt1.value = county;
                opt1.textContent = county;
                countyFilter.appendChild(opt1);

                const opt2 = document.createElement('option');
                opt2.value = county;
                opt2.textContent = county;
                graphCountyFilter.appendChild(opt2);
            });

            function applyFilters() {
                const county = countyFilter.value;
                const party = partyFilter.value;

                const rows = document.querySelectorAll('#voter-data tbody tr');

                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const rowCounty = cells[0].innerText;

                    let matches = true;

                    if (county !== 'all' && rowCounty !== county) {
                        matches = false;
                    }

                    if (party !== 'none') {
                        const partyMap = {
                            'Democrat': 1,
                            'Republican': 2,
                            'Green': 3,
                            'Libertarian': 4,
                            'Unaffiliated': 5,
                            'Other': 6
                        };
                        const partyIndex = partyMap[party];
                        const partyValue = parseInt(cells[partyIndex].innerText.replace(/,/g, '')) || 0;
                        if (partyValue <= 0) {
                            matches = false;
                        }
                    }

                    row.style.display = matches ? '' : 'none';
                });

                table.page('first').draw('page');
            }

            countyFilter.addEventListener('change', () => {
                applyFilters();
                graphCountyFilter.value = countyFilter.value;
                updateBarChart(graphCountyFilter.value);
            });

            partyFilter.addEventListener('change', applyFilters);

            graphCountyFilter.addEventListener('change', () => {
                countyFilter.value = graphCountyFilter.value;
                applyFilters();
                updateBarChart(graphCountyFilter.value);
            });

            resetButton.addEventListener('click', () => {
                countyFilter.value = 'all';
                partyFilter.value = 'none';
                applyFilters();
                updateBarChart('all');
            });

            applyFilters();
            updateBarChart('all');
        });
    </script>

    <script>
        const graphData = {{ graph_data | tojson }};
        const chartCanvas = document.getElementById('turnout-chart').getContext('2d');

        let barChart = new Chart(chartCanvas, {
            type: 'bar',
            data: {
                labels: ["Democrat", "Republican", "Green", "Libertarian", "Unaffiliated", "Other"],
                datasets: [{
                    label: 'Difference in Voters (2020 â†’ 2024)',
                    data: Array(6).fill(0),
                    backgroundColor: [
                        'rgba(70, 130, 180, 0.7)',   // Democrat
                        'rgba(220, 100, 100, 0.7)',  // Republican
                        'rgba(120, 200, 120, 0.7)',  // Green
                        'rgba(240, 200, 130, 0.7)',  // Libertarian
                        'rgba(180, 180, 180, 0.7)',  // Unaffiliated
                        'rgba(255, 170, 100, 0.7)'   // Other
                    ],
                    borderColor: [
                        'rgba(70, 130, 180, 1)',
                        'rgba(220, 100, 100, 1)',
                        'rgba(120, 200, 120, 1)',
                        'rgba(240, 200, 130, 1)',
                        'rgba(180, 180, 180, 1)',
                        'rgba(255, 170, 100, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Change in Voter Count'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Party'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });

        function updateBarChart(county) {
            let diffs;

            if (county === 'all') {
                diffs = graphData.reduce((totals, row) => {
                    totals[0] += row.democrat_diff;
                    totals[1] += row.republican_diff;
                    totals[2] += row.green_diff;
                    totals[3] += row.libertarian_diff;
                    totals[4] += row.unaffiliated_diff;
                    totals[5] += row.other_diff;
                    return totals;
                }, Array(6).fill(0));
            } else {
                const countyData = graphData.find(row => row.county === county);
                if (!countyData) return;
                diffs = [
                    countyData.democrat_diff,
                    countyData.republican_diff,
                    countyData.green_diff,
                    countyData.libertarian_diff,
                    countyData.unaffiliated_diff,
                    countyData.other_diff
                ];
            }

            barChart.data.datasets[0].data = diffs;
            barChart.update();
        }
    </script>
</body>

</html>
