<!doctype html>
<html lang="en">

<head>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="//cdn.datatables.net/2.0.0/css/dataTables.dataTables.min.css" />
    <script src="//cdn.datatables.net/2.0.0/js/dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            color: #333;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        h1,
        h2,
        h3 {
            font-family: 'Overpass', sans-serif;
            color: #333;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .dashboard-container {
            display: flex;
            flex-direction: column;
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        .controls-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
        }

        .county-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        select,
        button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Poppins', sans-serif;
            background-color: white;
        }

        button {
            cursor: pointer;
            background-color: #4a6fa5;
            color: white;
            border: none;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #3a5a8a;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            background-color: #f5f5f5;
            margin-right: 5px;
        }

        .tab.active {
            background-color: white;
            border-color: #ddd;
            border-bottom-color: white;
            font-weight: 600;
        }

        .tab-content {
            display: none;
            margin-top: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .chart-container {
            height: 400px;
            margin-bottom: 30px;
        }

        .data-tables {
            margin-top: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        table th {
            background-color: #f2f2f2;
        }

        .comparison-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .comparison-county {
            flex: 1;
            min-width: 300px;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }

        .sidenav {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1;
            top: 0;
            left: 0;
            background-color: #111;
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
        }

        .sidenav a {
            padding: 8px 8px 8px 32px;
            text-decoration: none;
            font-size: 18px;
            color: #818181;
            display: block;
            transition: 0.3s;
        }

        .sidenav a:hover {
            color: #f1f1f1;
        }

        .sidenav .closebtn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 36px;
            margin-left: 50px;
        }

        @media screen and (max-height: 450px) {
            .sidenav {
                padding-top: 15px;
            }

            .sidenav a {
                font-size: 18px;
            }
        }

        .county-header {
            background-color: #4a6fa5;
            color: white;
            padding: 10px 15px;
            margin-top: 0;
            border-radius: 4px;
        }

        .dataTables_wrapper {
            margin-bottom: 30px;
        }

        .data-card {
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .summary-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            flex: 1;
            min-width: 200px;
            background-color: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-title {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: 600;
            color: #333;
        }

        .stat-card.democrat {
            border-top: 4px solid rgba(70, 130, 180, 0.7);
        }

        .stat-card.republican {
            border-top: 4px solid rgba(220, 100, 100, 0.7);
        }

        .stat-card.unaffiliated {
            border-top: 4px solid rgba(180, 180, 180, 0.7);
        }

        .stat-card.total {
            border-top: 4px solid #333;
        }

        /* Custom styling for the toggle switch */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #other-display-toggle {
            position: relative;
            width: 40px;
            height: 20px;
            -webkit-appearance: none;
            appearance: none;
            background-color: #ccc;
            border-radius: 20px;
            outline: none;
            cursor: pointer;
            transition: 0.3s;
        }

        #other-display-toggle:checked {
            background-color: #4a6fa5;
        }

        #other-display-toggle:before {
            content: "";
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            top: 1px;
            left: 1px;
            background-color: white;
            transition: 0.3s;
        }

        #other-display-toggle:checked:before {
            left: 21px;
        }
    </style>
    <title>Maryland Voter Turnout Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Overpass:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">
</head>

<body>
    <div id="flask-data" data-counties='{{ counties | tojson }}' data-official='{{ official_data | tojson }}'
        data-active='{{ active_data | tojson }}' data-inactive='{{ inactive_data | tojson }}' style="display:none;">
    </div>

    <span style="font-size:30px;cursor:pointer" onclick="openNav()">&#9776; Menu</span>

    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <a href="#">Home</a>
        <a href="official-turnout">Official Maryland Turnout</a>
        <a href="eligible-active">Eligible Active Voters</a>
        <a href="eligible-inactive">Eligible Inactive Voters</a>
        <a href="county-dashboard" class="active">County Dashboard</a>
    </div>

    <div class="dashboard-container">
        <h1>Maryland Voter Turnout Dashboard</h1>

        <div class="controls-container">
            <div class="county-controls">
                <div class="filter-group">
                    <label for="primary-county-select"><strong>Primary County:</strong></label>
                    <select id="primary-county-select">
                        <option value="">Select County</option>
                    </select>
                </div>

                <div id="comparison-controls" style="display: none;">
                    <div class="filter-group">
                        <label for="comparison-county-select"><strong>Compare With:</strong></label>
                        <select id="comparison-county-select">
                            <option value="">Select County</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button id="enable-comparison-btn">Enable Comparison</button>
                <button id="disable-comparison-btn" style="display: none;">Disable Comparison</button>
            </div>
        </div>

        <div id="single-county-view">
            <h2 id="county-name-header" class="county-header">Select a county to view data</h2>

            <div class="tabs">
                <div class="tab active" data-tab="overview">Overview</div>
                <div class="tab" data-tab="official-turnout">Official Turnout</div>
                <div class="tab" data-tab="active-voters">Active Voters</div>
                <div class="tab" data-tab="inactive-voters">Inactive Voters</div>
            </div>

            <div id="overview" class="tab-content active">
                <div class="summary-stats">
                    <div class="stat-card total">
                        <div class="stat-title">Total Turnout Change (2020 → 2024)</div>
                        <div id="total-turnout-change" class="stat-value">-</div>
                    </div>
                    <div class="stat-card democrat">
                        <div class="stat-title">Democrat Turnout Change</div>
                        <div id="democrat-turnout-change" class="stat-value">-</div>
                    </div>
                    <div class="stat-card republican">
                        <div class="stat-title">Republican Turnout Change</div>
                        <div id="republican-turnout-change" class="stat-value">-</div>
                    </div>
                    <div class="stat-card unaffiliated">
                        <div class="stat-title">Unaffiliated Turnout Change</div>
                        <div id="unaffiliated-turnout-change" class="stat-value">-</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>Turnout Change By Party (2020 → 2024)</h3>
                    <canvas id="overview-chart"></canvas>
                </div>
            </div>

            <div id="official-turnout" class="tab-content">
                <div class="data-card">
                    <h3>Official Turnout Data</h3>
                    <div class="chart-container">
                        <canvas id="official-turnout-chart"></canvas>
                    </div>

                    <div class="data-tables">
                        <table id="official-turnout-table" class="display" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Party</th>
                                    <th>Change (2020 → 2024)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Democrat</td>
                                    <td id="official-democrat">-</td>
                                </tr>
                                <tr>
                                    <td>Republican</td>
                                    <td id="official-republican">-</td>
                                </tr>
                                <tr>
                                    <td>Green</td>
                                    <td id="official-green">-</td>
                                </tr>
                                <tr>
                                    <td>Libertarian</td>
                                    <td id="official-libertarian">-</td>
                                </tr>
                                <tr>
                                    <td>Unaffiliated</td>
                                    <td id="official-unaffiliated">-</td>
                                </tr>
                                <tr>
                                    <td>Other</td>
                                    <td id="official-other">-</td>
                                </tr>
                                <tr>
                                    <td>Statewide</td>
                                    <td id="official-statewide">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="active-voters" class="tab-content">
                <div class="data-card">
                    <h3>Eligible Active Voters</h3>
                    <div class="chart-container">
                        <canvas id="active-voters-chart"></canvas>
                    </div>

                    <div class="data-tables">
                        <table id="active-voters-table" class="display" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Party</th>
                                    <th>Change (2020 → 2024)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Democrat</td>
                                    <td id="active-democrat">-</td>
                                </tr>
                                <tr>
                                    <td>Republican</td>
                                    <td id="active-republican">-</td>
                                </tr>
                                <tr>
                                    <td>Green</td>
                                    <td id="active-green">-</td>
                                </tr>
                                <tr>
                                    <td>Libertarian</td>
                                    <td id="active-libertarian">-</td>
                                </tr>
                                <tr>
                                    <td>Unaffiliated</td>
                                    <td id="active-unaffiliated">-</td>
                                </tr>
                                <tr>
                                    <td>Other</td>
                                    <td id="active-other">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="inactive-voters" class="tab-content">
                <div class="data-card">
                    <h3>Eligible Inactive Voters</h3>
                    <div class="chart-container">
                        <canvas id="inactive-voters-chart"></canvas>
                    </div>

                    <div class="data-tables">
                        <table id="inactive-voters-table" class="display" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Party</th>
                                    <th>Change (2020 → 2024)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Democrat</td>
                                    <td id="inactive-democrat">-</td>
                                </tr>
                                <tr>
                                    <td>Republican</td>
                                    <td id="inactive-republican">-</td>
                                </tr>
                                <tr>
                                    <td>Green</td>
                                    <td id="inactive-green">-</td>
                                </tr>
                                <tr>
                                    <td>Libertarian</td>
                                    <td id="inactive-libertarian">-</td>
                                </tr>
                                <tr>
                                    <td>Unaffiliated</td>
                                    <td id="inactive-unaffiliated">-</td>
                                </tr>
                                <tr>
                                    <td>Other</td>
                                    <td id="inactive-other">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="comparison-view" style="display: none;">
            <h2>County Comparison</h2>

            <div class="comparison-container">
                <div class="comparison-county">
                    <h3 id="county1-name" class="county-header">County 1</h3>
                    <div class="chart-container">
                        <canvas id="county1-chart"></canvas>
                    </div>

                    <div class="data-tables">
                        <table class="display" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Democrat</th>
                                    <th>Republican</th>
                                    <th>Unaffiliated</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Official Turnout</td>
                                    <td id="county1-official-democrat">-</td>
                                    <td id="county1-official-republican">-</td>
                                    <td id="county1-official-unaffiliated">-</td>
                                </tr>
                                <tr>
                                    <td>Active Voters</td>
                                    <td id="county1-active-democrat">-</td>
                                    <td id="county1-active-republican">-</td>
                                    <td id="county1-active-unaffiliated">-</td>
                                </tr>
                                <tr>
                                    <td>Inactive Voters</td>
                                    <td id="county1-inactive-democrat">-</td>
                                    <td id="county1-inactive-republican">-</td>
                                    <td id="county1-inactive-unaffiliated">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="comparison-county">
                    <h3 id="county2-name" class="county-header">County 2</h3>
                    <div class="chart-container">
                        <canvas id="county2-chart"></canvas>
                    </div>

                    <div class="data-tables">
                        <table class="display" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Democrat</th>
                                    <th>Republican</th>
                                    <th>Unaffiliated</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Official Turnout</td>
                                    <td id="county2-official-democrat">-</td>
                                    <td id="county2-official-republican">-</td>
                                    <td id="county2-official-unaffiliated">-</td>
                                </tr>
                                <tr>
                                    <td>Active Voters</td>
                                    <td id="county2-active-democrat">-</td>
                                    <td id="county2-active-republican">-</td>
                                    <td id="county2-active-unaffiliated">-</td>
                                </tr>
                                <tr>
                                    <td>Inactive Voters</td>
                                    <td id="county2-inactive-democrat">-</td>
                                    <td id="county2-inactive-republican">-</td>
                                    <td id="county2-inactive-unaffiliated">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            console.log("Initializing dashboard");

            // Define chartColors and chartBorders globally for consistent styling
            const chartColors = {
                democrat: 'rgba(70, 130, 180, 0.7)',    // steel blue
                republican: 'rgba(220, 100, 100, 0.7)', // soft red
                green: 'rgba(120, 200, 120, 0.7)',      // leafy green
                libertarian: 'rgba(240, 200, 130, 0.7)',// warm gold
                unaffiliated: 'rgba(180, 180, 180, 0.7)',// medium gray
                other: 'rgba(255, 170, 100, 0.7)',      // pumpkin orange
                statewide: 'rgba(100, 100, 100, 0.7)'   // dark gray
            };

            const chartBorders = {
                democrat: 'rgba(70, 130, 180, 1)',
                republican: 'rgba(220, 100, 100, 1)',
                green: 'rgba(120, 200, 120, 1)',
                libertarian: 'rgba(240, 200, 130, 1)',
                unaffiliated: 'rgba(180, 180, 180, 1)',
                other: 'rgba(255, 170, 100, 1)',
                statewide: 'rgba(100, 100, 100, 1)'
            };

            // Hardcoded counties from Maryland
            // const hardcodedCounties = [
            //     'Allegany', 'Anne Arundel', 'Baltimore City', 'Baltimore County',
            //     'Calvert', 'Caroline', 'Carroll', 'Cecil', 'Charles', 'Dorchester',
            //     'Frederick', 'Garrett', 'Harford', 'Howard', 'Kent', 'Montgomery',
            //     "Prince George's", "Queen Anne's", "Saint Mary's", 'Somerset',
            //     'Talbot', 'Washington', 'Wicomico', 'Worcester'
            // ];


            // Generate mock data for each county
            // const mockData = {
            //     officialTurnoutData: [],
            //     activeVotersData: [],
            //     inactiveVotersData: [],
            //     counties: hardcodedCounties
            // };

            // hardcodedCounties.forEach(county => {
            //     // Generate mock official turnout data
            //     mockData.officialTurnoutData.push({
            //         county: county,
            //         democrat_diff: parseFloat((Math.random() * 6 - 3).toFixed(1)),
            //         republican_diff: parseFloat((Math.random() * 6 - 2).toFixed(1)),
            //         green_diff: parseFloat((Math.random() * 0.4 - 0.2).toFixed(1)),
            //         libertarian_diff: parseFloat((Math.random() * 0.4 - 0.2).toFixed(1)),
            //         unaffiliated_diff: parseFloat((Math.random() * 2 - 0.5).toFixed(1)),
            //         other_diff: parseFloat((Math.random() * 0.4 - 0.1).toFixed(1)),
            //         statewide_diff: parseFloat((Math.random() * 2 - 0.5).toFixed(1))
            //     });

            //     // Generate mock active voters data
            //     mockData.activeVotersData.push({
            //         county: county,
            //         democrat_diff: Math.round(Math.random() * 2000 - 1000),
            //         republican_diff: Math.round(Math.random() * 2000 - 800),
            //         green_diff: Math.round(Math.random() * 200 - 100),
            //         libertarian_diff: Math.round(Math.random() * 200 - 100),
            //         unaffiliated_diff: Math.round(Math.random() * 1000 - 300),
            //         other_diff: Math.round(Math.random() * 200 - 50)
            //     });

            //     // Generate mock inactive voters data
            //     mockData.inactiveVotersData.push({
            //         county: county,
            //         democrat_diff: Math.round(Math.random() * 1000 - 500),
            //         republican_diff: Math.round(Math.random() * 1000 - 500),
            //         green_diff: Math.round(Math.random() * 100 - 50),
            //         libertarian_diff: Math.round(Math.random() * 100 - 50),
            //         unaffiliated_diff: Math.round(Math.random() * 500 - 250),
            //         other_diff: Math.round(Math.random() * 100 - 50)
            //     });
            // });

            console.log("Generated mock data for all counties");

            // Make data globally available
            // window.officialTurnoutData = mockData.officialTurnoutData;
            // window.activeVotersData = mockData.activeVotersData;
            // window.inactiveVotersData = mockData.inactiveVotersData;
            // window.counties = mockData.counties;

            const flaskDataElement = document.getElementById('flask-data');
            console.log("Flask Data Element:", flaskDataElement.dataset);

            window.officialTurnoutData = JSON.parse(flaskDataElement.dataset.official);
            window.activeVotersData = JSON.parse(flaskDataElement.dataset.active);
            window.inactiveVotersData = JSON.parse(flaskDataElement.dataset.inactive);
            window.counties = JSON.parse(flaskDataElement.dataset.counties);

            const hardcodedCounties = window.counties;
            console.log("Using counties from Flask:", hardcodedCounties);

            window.officialTurnoutData = JSON.parse(flaskDataElement.dataset.official);
            window.activeVotersData = JSON.parse(flaskDataElement.dataset.active);
            window.inactiveVotersData = JSON.parse(flaskDataElement.dataset.inactive);
            window.counties = JSON.parse(flaskDataElement.dataset.counties);

            // Helper function to format numbers
            window.formatNumber = function (num) {
                if (num === null || num === undefined) return '-';

                // For percentages (small decimal numbers)
                if (Math.abs(num) < 10 && num.toString().includes('.')) {
                    return num > 0 ? `+${num}%` : `${num}%`;
                }

                // For larger numbers (voter counts)
                return num > 0 ? `+${num.toLocaleString()}` : num.toLocaleString();
            };

            // Complete the updateSingleCountyView function
            window.updateSingleCountyView = function (county) {
                console.log("Updating view for county:", county);

                // Update the county header
                document.getElementById('county-name-header').textContent = county;

                // Find data for the selected county
                const officialData = window.officialTurnoutData.find(item => item.county === county) || {};
                const activeData = window.activeVotersData.find(item => item.county === county) || {};
                const inactiveData = window.inactiveVotersData.find(item => item.county === county) || {};

                // Update the overview tab
                document.getElementById('total-turnout-change').textContent = formatNumber(officialData.statewide_diff);
                document.getElementById('democrat-turnout-change').textContent = formatNumber(officialData.democrat_diff);
                document.getElementById('republican-turnout-change').textContent = formatNumber(officialData.republican_diff);
                document.getElementById('unaffiliated-turnout-change').textContent = formatNumber(officialData.unaffiliated_diff);

                // Update the official turnout tab
                document.getElementById('official-democrat').textContent = formatNumber(officialData.democrat_diff);
                document.getElementById('official-republican').textContent = formatNumber(officialData.republican_diff);
                document.getElementById('official-green').textContent = formatNumber(officialData.green_diff);
                document.getElementById('official-libertarian').textContent = formatNumber(officialData.libertarian_diff);
                document.getElementById('official-unaffiliated').textContent = formatNumber(officialData.unaffiliated_diff);
                document.getElementById('official-other').textContent = formatNumber(officialData.other_diff);
                document.getElementById('official-statewide').textContent = formatNumber(officialData.statewide_diff);

                // Update the active voters tab
                document.getElementById('active-democrat').textContent = formatNumber(activeData.democrat_diff);
                document.getElementById('active-republican').textContent = formatNumber(activeData.republican_diff);
                document.getElementById('active-green').textContent = formatNumber(activeData.green_diff);
                document.getElementById('active-libertarian').textContent = formatNumber(activeData.libertarian_diff);
                document.getElementById('active-unaffiliated').textContent = formatNumber(activeData.unaffiliated_diff);
                document.getElementById('active-other').textContent = formatNumber(activeData.other_diff);

                // Update the inactive voters tab
                document.getElementById('inactive-democrat').textContent = formatNumber(inactiveData.democrat_diff);
                document.getElementById('inactive-republican').textContent = formatNumber(inactiveData.republican_diff);
                document.getElementById('inactive-green').textContent = formatNumber(inactiveData.green_diff);
                document.getElementById('inactive-libertarian').textContent = formatNumber(inactiveData.libertarian_diff);
                document.getElementById('inactive-unaffiliated').textContent = formatNumber(inactiveData.unaffiliated_diff);
                document.getElementById('inactive-other').textContent = formatNumber(inactiveData.other_diff);

                // Update the charts
                updateOverviewChart(officialData);
                updateOfficialTurnoutChart(officialData);
                updateActiveVotersChart(activeData);
                updateInactiveVotersChart(inactiveData);
            }

            // Function to update the comparison view
            window.updateComparisonView = function (county1, county2) {
                // Show comparison view, hide single county view
                document.getElementById('single-county-view').style.display = 'none';
                document.getElementById('comparison-view').style.display = 'block';

                // Set county names in headers
                document.getElementById('county1-name').textContent = county1;
                document.getElementById('county2-name').textContent = county2;

                // Find data for both counties
                const county1OfficialData = window.officialTurnoutData.find(item => item.county === county1) || {};
                const county1ActiveData = window.activeVotersData.find(item => item.county === county1) || {};
                const county1InactiveData = window.inactiveVotersData.find(item => item.county === county1) || {};

                const county2OfficialData = window.officialTurnoutData.find(item => item.county === county2) || {};
                const county2ActiveData = window.activeVotersData.find(item => item.county === county2) || {};
                const county2InactiveData = window.inactiveVotersData.find(item => item.county === county2) || {};

                // Update county 1 data cells
                document.getElementById('county1-official-democrat').textContent = formatNumber(county1OfficialData.democrat_diff);
                document.getElementById('county1-official-republican').textContent = formatNumber(county1OfficialData.republican_diff);
                document.getElementById('county1-official-unaffiliated').textContent = formatNumber(county1OfficialData.unaffiliated_diff);

                document.getElementById('county1-active-democrat').textContent = formatNumber(county1ActiveData.democrat_diff);
                document.getElementById('county1-active-republican').textContent = formatNumber(county1ActiveData.republican_diff);
                document.getElementById('county1-active-unaffiliated').textContent = formatNumber(county1ActiveData.unaffiliated_diff);

                document.getElementById('county1-inactive-democrat').textContent = formatNumber(county1InactiveData.democrat_diff);
                document.getElementById('county1-inactive-republican').textContent = formatNumber(county1InactiveData.republican_diff);
                document.getElementById('county1-inactive-unaffiliated').textContent = formatNumber(county1InactiveData.unaffiliated_diff);

                // Update county 2 data cells
                document.getElementById('county2-official-democrat').textContent = formatNumber(county2OfficialData.democrat_diff);
                document.getElementById('county2-official-republican').textContent = formatNumber(county2OfficialData.republican_diff);
                document.getElementById('county2-official-unaffiliated').textContent = formatNumber(county2OfficialData.unaffiliated_diff);

                document.getElementById('county2-active-democrat').textContent = formatNumber(county2ActiveData.democrat_diff);
                document.getElementById('county2-active-republican').textContent = formatNumber(county2ActiveData.republican_diff);
                document.getElementById('county2-active-unaffiliated').textContent = formatNumber(county2ActiveData.unaffiliated_diff);

                document.getElementById('county2-inactive-democrat').textContent = formatNumber(county2InactiveData.democrat_diff);
                document.getElementById('county2-inactive-republican').textContent = formatNumber(county2InactiveData.republican_diff);
                document.getElementById('county2-inactive-unaffiliated').textContent = formatNumber(county2InactiveData.unaffiliated_diff);

                // Update comparison charts
                updateComparisonCharts(county1, county2);
            };

            // Chart update functions
            function updateOverviewChart(data) {
                const ctx = document.getElementById('overview-chart').getContext('2d');

                // Destroy existing chart if it exists
                if (window.overviewChart) {
                    window.overviewChart.destroy();
                }

                window.overviewChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Democrat', 'Republican', 'Green', 'Libertarian', 'Unaffiliated', 'Other', 'Total'],
                        datasets: [{
                            label: 'Change in Voter Turnout % (2020 → 2024)',
                            data: [
                                data.democrat_diff,
                                data.republican_diff,
                                data.green_diff,
                                data.libertarian_diff,
                                data.unaffiliated_diff,
                                data.other_diff,
                                data.statewide_diff
                            ],
                            backgroundColor: [
                                chartColors.democrat,
                                chartColors.republican,
                                chartColors.green,
                                chartColors.libertarian,
                                chartColors.unaffiliated,
                                chartColors.other,
                                chartColors.statewide
                            ],
                            borderColor: [
                                chartBorders.democrat,
                                chartBorders.republican,
                                chartBorders.green,
                                chartBorders.libertarian,
                                chartBorders.unaffiliated,
                                chartBorders.other,
                                chartBorders.statewide
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Percentage Change'
                                }
                            }
                        }
                    }
                });
            }

            function updateOfficialTurnoutChart(data) {
                const ctx = document.getElementById('official-turnout-chart').getContext('2d');

                // Destroy existing chart if it exists
                if (window.officialTurnoutChart) {
                    window.officialTurnoutChart.destroy();
                }

                window.officialTurnoutChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Democrat', 'Republican', 'Green', 'Libertarian', 'Unaffiliated', 'Other', 'Total'],
                        datasets: [{
                            label: 'Official Turnout Change % (2020 → 2024)',
                            data: [
                                data.democrat_diff,
                                data.republican_diff,
                                data.green_diff,
                                data.libertarian_diff,
                                data.unaffiliated_diff,
                                data.other_diff,
                                data.statewide_diff
                            ],
                            backgroundColor: [
                                chartColors.democrat,
                                chartColors.republican,
                                chartColors.green,
                                chartColors.libertarian,
                                chartColors.unaffiliated,
                                chartColors.other,
                                chartColors.statewide
                            ],
                            borderColor: [
                                chartBorders.democrat,
                                chartBorders.republican,
                                chartBorders.green,
                                chartBorders.libertarian,
                                chartBorders.unaffiliated,
                                chartBorders.other,
                                chartBorders.statewide
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                title: {
                                    display: true,
                                    text: 'Percentage Change'
                                }
                            }
                        }
                    }
                });
            }

            function updateActiveVotersChart(data) {
                const ctx = document.getElementById('active-voters-chart').getContext('2d');

                // Destroy existing chart if it exists
                if (window.activeVotersChart) {
                    window.activeVotersChart.destroy();
                }

                window.activeVotersChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Democrat', 'Republican', 'Green', 'Libertarian', 'Unaffiliated', 'Other'],
                        datasets: [{
                            label: 'Change in Active Voters (2020 → 2024)',
                            data: [
                                data.democrat_diff,
                                data.republican_diff,
                                data.green_diff,
                                data.libertarian_diff,
                                data.unaffiliated_diff,
                                data.other_diff
                            ],
                            backgroundColor: [
                                chartColors.democrat,
                                chartColors.republican,
                                chartColors.green,
                                chartColors.libertarian,
                                chartColors.unaffiliated,
                                chartColors.other
                            ],
                            borderColor: [
                                chartBorders.democrat,
                                chartBorders.republican,
                                chartBorders.green,
                                chartBorders.libertarian,
                                chartBorders.unaffiliated,
                                chartBorders.other
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                title: {
                                    display: true,
                                    text: 'Change in Voter Count'
                                }
                            }
                        }
                    }
                });
            }

            function updateInactiveVotersChart(data) {
                const ctx = document.getElementById('inactive-voters-chart').getContext('2d');

                // Destroy existing chart if it exists
                if (window.inactiveVotersChart) {
                    window.inactiveVotersChart.destroy();
                }

                window.inactiveVotersChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Democrat', 'Republican', 'Green', 'Libertarian', 'Unaffiliated', 'Other'],
                        datasets: [{
                            label: 'Change in Inactive Voters (2020 → 2024)',
                            data: [
                                data.democrat_diff,
                                data.republican_diff,
                                data.green_diff,
                                data.libertarian_diff,
                                data.unaffiliated_diff,
                                data.other_diff
                            ],
                            backgroundColor: [
                                chartColors.democrat,
                                chartColors.republican,
                                chartColors.green,
                                chartColors.libertarian,
                                chartColors.unaffiliated,
                                chartColors.other
                            ],
                            borderColor: [
                                chartBorders.democrat,
                                chartBorders.republican,
                                chartBorders.green,
                                chartBorders.libertarian,
                                chartBorders.unaffiliated,
                                chartBorders.other
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                title: {
                                    display: true,
                                    text: 'Change in Voter Count'
                                }
                            }
                        }
                    }
                });
            }

            function updateComparisonCharts(county1, county2) {
                // County 1 chart
                const county1Data = window.officialTurnoutData.find(item => item.county === county1);
                const ctx1 = document.getElementById('county1-chart').getContext('2d');

                if (window.county1Chart) {
                    window.county1Chart.destroy();
                }

                window.county1Chart = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: ['Democrat', 'Republican', 'Unaffiliated'],
                        datasets: [{
                            label: 'Turnout Change %',
                            data: [
                                county1Data.democrat_diff,
                                county1Data.republican_diff,
                                county1Data.unaffiliated_diff
                            ],
                            backgroundColor: [
                                chartColors.democrat,
                                chartColors.republican,
                                chartColors.unaffiliated
                            ],
                            borderColor: [
                                chartBorders.democrat,
                                chartBorders.republican,
                                chartBorders.unaffiliated
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `${county1} Turnout Change (2020 → 2024)`
                            }
                        }
                    }
                });

                // County 2 chart
                const county2Data = window.officialTurnoutData.find(item => item.county === county2);
                const ctx2 = document.getElementById('county2-chart').getContext('2d');

                if (window.county2Chart) {
                    window.county2Chart.destroy();
                }

                window.county2Chart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: ['Democrat', 'Republican', 'Unaffiliated'],
                        datasets: [{
                            label: 'Turnout Change %',
                            data: [
                                county2Data.democrat_diff,
                                county2Data.republican_diff,
                                county2Data.unaffiliated_diff
                            ],
                            backgroundColor: [
                                chartColors.democrat,
                                chartColors.republican,
                                chartColors.unaffiliated
                            ],
                            borderColor: [
                                chartBorders.democrat,
                                chartBorders.republican,
                                chartBorders.unaffiliated
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `${county2} Turnout Change (2020 → 2024)`
                            }
                        }
                    }
                });
            }

            // Set up sidebar navigation
            window.openNav = function () {
                document.getElementById("mySidenav").style.width = "250px";
            };

            window.closeNav = function () {
                document.getElementById("mySidenav").style.width = "0";
            };

            // Populate dropdown menus
            const primarySelect = document.getElementById('primary-county-select');
            const comparisonSelect = document.getElementById('comparison-county-select');

            // Clear existing options
            primarySelect.innerHTML = '<option value="">Select County</option>';
            comparisonSelect.innerHTML = '<option value="">Select County</option>';

            // Add counties to dropdowns
            hardcodedCounties.forEach(county => {
                const primaryOption = document.createElement('option');
                primaryOption.value = county;
                primaryOption.textContent = county;
                primarySelect.appendChild(primaryOption);

                const comparisonOption = document.createElement('option');
                comparisonOption.value = county;
                comparisonOption.textContent = county;
                comparisonSelect.appendChild(comparisonOption);
            });

            // Set up event listeners

            // Primary county selection
            primarySelect.addEventListener('change', function () {
                const selectedCounty = this.value;
                if (selectedCounty) {
                    updateSingleCountyView(selectedCounty);

                    // If we're in comparison mode and have a second county selected
                    const comparisonCounty = comparisonSelect.value;
                    if (document.getElementById('comparison-view').style.display === 'block' && comparisonCounty) {
                        updateComparisonView(selectedCounty, comparisonCounty);
                    } else {
                        // Otherwise, make sure we're in single county view
                        document.getElementById('single-county-view').style.display = 'block';
                        document.getElementById('comparison-view').style.display = 'none';
                    }
                }
            });

            // Comparison county selection
            comparisonSelect.addEventListener('change', function () {
                const selectedCounty = this.value;
                const primaryCounty = primarySelect.value;

                if (selectedCounty && primaryCounty) {
                    updateComparisonView(primaryCounty, selectedCounty);
                }
            });

            // Enable comparison button
            document.getElementById('enable-comparison-btn').addEventListener('click', function () {
                document.getElementById('comparison-controls').style.display = 'block';
                this.style.display = 'none';
                document.getElementById('disable-comparison-btn').style.display = 'inline-block';
            });

            // Disable comparison button
            document.getElementById('disable-comparison-btn').addEventListener('click', function () {
                document.getElementById('comparison-controls').style.display = 'none';
                this.style.display = 'none';
                document.getElementById('enable-comparison-btn').style.display = 'inline-block';

                // Switch back to single county view
                document.getElementById('single-county-view').style.display = 'block';
                document.getElementById('comparison-view').style.display = 'none';

                // Reset comparison dropdown
                comparisonSelect.value = '';

                // Refresh the single county view with currently selected county
                const selectedCounty = primarySelect.value;
                if (selectedCounty) {
                    updateSingleCountyView(selectedCounty);
                }
            });

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    // Remove active class from all tabs
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    // Add active class to clicked tab
                    this.classList.add('active');

                    // Hide all tab content
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                    // Show relevant tab content
                    const tabName = this.getAttribute('data-tab');
                    document.getElementById(tabName).classList.add('active');
                });
            });

            // Initialize with the first county
            if (hardcodedCounties.length > 0) {
                primarySelect.value = hardcodedCounties[0];
                updateSingleCountyView(hardcodedCounties[0]);
            }

            // Initialize DataTables
            $(document).ready(function () {
                $('#official-turnout-table').DataTable({
                    paging: false,
                    searching: false,
                    info: false
                });

                $('#active-voters-table').DataTable({
                    paging: false,
                    searching: false,
                    info: false
                });

                $('#inactive-voters-table').DataTable({
                    paging: false,
                    searching: false,
                    info: false
                });
            });

            // REMOVED: The function that adds the Other category detail section
            // REMOVED: The setTimeout call to initialize the Other category enhancement

            console.log("Dashboard initialization complete");
        });
    </script>
</body>