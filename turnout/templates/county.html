<!doctype html>
<html lang="en">

<head>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="//cdn.datatables.net/2.0.0/css/dataTables.dataTables.min.css" />
    <script src="//cdn.datatables.net/2.0.0/js/dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CNS Style Guide Colors */
        :root {
            /* Main Graphics Colors */
            --cns-blue: #1979b9;
            --cns-orange: #faa916;
            --cns-red: #c71e1d;

            /* Secondary/Accent Colors */
            --cns-purple: #80217f;
            --cns-bright-orange: #de5826;
            --cns-teal: #2ec4b6;
            --cns-green: #8fd694;

            /* Website Colors */
            --cns-yellow: #fbd603;
            --cns-maroon: #990000;
            --cns-black: #0a0a0a;
            --cns-gray: #666666;
        }

        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            color: var(--cns-black);
            margin: 0;
            padding: 20px;
            background-color: #FAF9F6;
        }

        h1 {
            font-family: 'Source Serif Pro', serif;
            color: var(--cns-blue);
            margin-bottom: 30px;
            font-size: 2.5em;
            text-align: center;
        }

        h2,
        h3 {
            font-family: 'Source Serif Pro', serif;
            color: var(--cns-black);
        }

        .dashboard-container {
            display: flex;
            flex-direction: column;
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        .controls-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
        }

        .county-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Poppins', sans-serif;
            background-color: white;
        }

        button {
            cursor: pointer;
            background-color: var(--cns-blue);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: 'Poppins', sans-serif;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--cns-yellow);
            color: var(--cns-black);
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            background-color: #f5f5f5;
            margin-right: 5px;
            font-family: 'Poppins', sans-serif;
        }

        .tab.active {
            background-color: white;
            border-color: #ddd;
            border-bottom-color: white;
            font-weight: 600;
        }

        .tab-content {
            display: none;
            margin-top: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .chart-container {
            height: 400px;
            margin-bottom: 30px;
        }

        .data-tables {
            margin-top: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background-color: white;
        }

        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-family: 'Poppins', sans-serif;
        }

        table th {
            background-color: #f2f2f2;
        }

        .comparison-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .comparison-county {
            flex: 1;
            min-width: 300px;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }

        .sidenav {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1;
            top: 0;
            left: 0;
            background-color: var(--cns-blue);
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
        }

        .sidenav a {
            padding: 8px 8px 8px 32px;
            text-decoration: none;
            font-family: 'Poppins', sans-serif;
            font-size: 18px;
            color: white;
            display: block;
            transition: 0.3s;
        }

        .sidenav a:hover {
            color: var(--cns-yellow);
        }

        .sidenav .closebtn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 36px;
            margin-left: 50px;
        }

        @media screen and (max-height: 450px) {
            .sidenav {
                padding-top: 15px;
            }

            .sidenav a {
                font-size: 18px;
            }
        }

        .county-header {
            background-color: var(--cns-blue);
            color: white;
            padding: 10px 15px;
            margin-top: 0;
            border-radius: 4px;
            font-family: 'Source Serif Pro', serif;
        }

        .dataTables_wrapper {
            margin-bottom: 30px;
        }

        .data-card {
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .summary-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            flex: 1;
            min-width: 200px;
            background-color: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-title {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
            font-family: 'Poppins', sans-serif;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: 600;
            color: #333;
            font-family: 'Poppins', sans-serif;
        }

        .stat-card.democrat {
            border-top: 4px solid var(--cns-blue);
        }

        .stat-card.republican {
            border-top: 4px solid var(--cns-red);
        }

        .stat-card.unaffiliated {
            border-top: 4px solid var(--cns-gray);
        }

        .stat-card.total {
            border-top: 4px solid var(--cns-black);
        }

        /* Chart notes and sources style - CNS guidelines */
        .chart-footer {
            margin-top: 10px;
            font-family: 'Poppins', sans-serif;
        }

        .chart-note {
            font-style: italic;
            font-size: 0.9em;
            color: #666;
        }

        .chart-source {
            font-family: 'Source Serif Pro', serif;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .chart-byline {
            font-family: 'Poppins', sans-serif;
            font-size: 0.9em;
            margin-top: 3px;
        }

        .chart-title {
            font-family: 'Source Serif Pro', serif;
            font-size: 1.2em;
            margin-bottom: 5px;
            color: var(--cns-black);
        }

        .chart-chatter {
            font-family: 'Poppins', sans-serif;
            font-size: 1em;
            margin-bottom: 15px;
            color: #555;
        }
    </style>
    <title>Maryland Voter Turnout Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:ital,wght@0,400;0,600;0,700;1,400&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap"
        rel="stylesheet">
</head>

<body>
    <div id="flask-data" data-counties='{{ counties | tojson }}' data-official='{{ official_data | tojson }}'
        data-active='{{ active_data | tojson }}' data-inactive='{{ inactive_data | tojson }}' style="display:none;">
    </div>

    <span style="font-size:30px;cursor:pointer" onclick="openNav()">&#9776; Menu</span>

    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <a href="/">Home</a>
        <a href="official-turnout">Official Maryland Turnout</a>
        <a href="eligible-active">Eligible Active Voters</a>
        <a href="eligible-inactive">Eligible Inactive Voters</a>
        <a href="county-dashboard" class="active">County Dashboard</a>
    </div>

    <div class="dashboard-container">
        <h1>Maryland Voter Turnout Dashboard</h1>

        <div class="controls-container">
            <div class="county-controls">
                <div class="filter-group">
                    <label for="primary-county-select"><strong>Primary County:</strong></label>
                    <select id="primary-county-select">
                        <option value="">Select County</option>
                    </select>
                </div>

                <div id="comparison-controls" style="display: none;">
                    <div class="filter-group">
                        <label for="comparison-county-select"><strong>Compare With:</strong></label>
                        <select id="comparison-county-select">
                            <option value="">Select County</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button id="enable-comparison-btn">Enable Comparison</button>
                <button id="disable-comparison-btn" style="display: none;">Disable Comparison</button>
            </div>
        </div>

        <div id="single-county-view">
            <h2 id="county-name-header" class="county-header">Select a county to view data</h2>

            <div class="tabs">
                <div class="tab active" data-tab="overview">Overview</div>
                <div class="tab" data-tab="official-turnout">Official Turnout</div>
                <div class="tab" data-tab="active-voters">Active Voters</div>
                <div class="tab" data-tab="inactive-voters">Inactive Voters</div>
            </div>

            <div id="overview" class="tab-content active">
                <div class="summary-stats">
                    <div class="stat-card total">
                        <div class="stat-title">Total Turnout Change (2020 → 2024)</div>
                        <div id="total-turnout-change" class="stat-value">-</div>
                    </div>
                    <div class="stat-card democrat">
                        <div class="stat-title">Democrat Turnout Change</div>
                        <div id="democrat-turnout-change" class="stat-value">-</div>
                    </div>
                    <div class="stat-card republican">
                        <div class="stat-title">Republican Turnout Change</div>
                        <div id="republican-turnout-change" class="stat-value">-</div>
                    </div>
                    <div class="stat-card unaffiliated">
                        <div class="stat-title">Unaffiliated Turnout Change</div>
                        <div id="unaffiliated-turnout-change" class="stat-value">-</div>
                    </div>
                </div>

                <div class="data-card">
                    <div class="chart-title">Turnout change by party in Maryland</div>
                    <div class="chart-chatter">Percentage point difference in voter turnout between 2020 and 2024
                        elections across parties.</div>
                    <div class="chart-container">
                        <canvas id="overview-chart"></canvas>
                    </div>
                    <div class="chart-footer">
                        <div class="chart-source">Source: Maryland State Board of Elections</div>
                        <div class="chart-byline">Chart: Philip Merrill College of Journalism at University of Maryland</div>
                    </div>
                </div>
            </div>

            <div id="official-turnout" class="tab-content">
                <div class="data-card">
                    <div class="chart-title">Official turnout data by party</div>
                    <div class="chart-chatter">Percentage change in official voter turnout across parties from 2020 to
                        2024.</div>
                    <div class="chart-container">
                        <canvas id="official-turnout-chart"></canvas>
                    </div>
                    <div class="chart-footer">
                        <div class="chart-note">Note: Percentages represent change in turnout rate, not raw voter
                            numbers.</div>
                        <div class="chart-source">Source: Maryland State Board of Elections</div>
                        <div class="chart-byline">Chart: Philip Merrill College of Journalism at University of Maryland</div>
                    </div>

                    <div class="data-tables">
                        <table id="official-turnout-table" class="display" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Party</th>
                                    <th>Change (2020 → 2024)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Democrat</td>
                                    <td id="official-democrat">-</td>
                                </tr>
                                <tr>
                                    <td>Republican</td>
                                    <td id="official-republican">-</td>
                                </tr>
                                <tr>
                                    <td>Green</td>
                                    <td id="official-green">-</td>
                                </tr>
                                <tr>
                                    <td>Libertarian</td>
                                    <td id="official-libertarian">-</td>
                                </tr>
                                <tr>
                                    <td>Unaffiliated</td>
                                    <td id="official-unaffiliated">-</td>
                                </tr>
                                <tr>
                                    <td>Other</td>
                                    <td id="official-other">-</td>
                                </tr>
                                <tr>
                                    <td>Statewide</td>
                                    <td id="official-statewide">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="active-voters" class="tab-content">
                <div class="data-card">
                    <div class="chart-title">Change in eligible active voters</div>
                    <div class="chart-chatter">Numeric change in eligible active voters by party affiliation from 2020
                        to 2024.</div>
                    <div class="chart-container">
                        <canvas id="active-voters-chart"></canvas>
                    </div>
                    <div class="chart-footer">
                        <div class="chart-source">Source: Maryland State Board of Elections</div>
                        <div class="chart-byline">Chart: Philip Merrill College of Journalism at University of Maryland</div>
                    </div>

                    <div class="data-tables">
                        <table id="active-voters-table" class="display" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Party</th>
                                    <th>Change (2020 → 2024)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Democrat</td>
                                    <td id="active-democrat">-</td>
                                </tr>
                                <tr>
                                    <td>Republican</td>
                                    <td id="active-republican">-</td>
                                </tr>
                                <tr>
                                    <td>Green</td>
                                    <td id="active-green">-</td>
                                </tr>
                                <tr>
                                    <td>Libertarian</td>
                                    <td id="active-libertarian">-</td>
                                </tr>
                                <tr>
                                    <td>Unaffiliated</td>
                                    <td id="active-unaffiliated">-</td>
                                </tr>
                                <tr>
                                    <td>Other</td>
                                    <td id="active-other">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="inactive-voters" class="tab-content">
                <div class="data-card">
                    <div class="chart-title">Change in eligible inactive voters</div>
                    <div class="chart-chatter">Numeric change in eligible inactive voters by party affiliation from 2020
                        to 2024.</div>
                    <div class="chart-container">
                        <canvas id="inactive-voters-chart"></canvas>
                    </div>
                    <div class="chart-footer">
                        <div class="chart-note">Note: Inactive voters are still eligible but have not responded to
                            address verification.</div>
                        <div class="chart-source">Source: Maryland State Board of Elections</div>
                        <div class="chart-byline">Chart: Philip Merrill College of Journalism at University of Maryland</div>
                    </div>

                    <div class="data-tables">
                        <table id="inactive-voters-table" class="display" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Party</th>
                                    <th>Change (2020 → 2024)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Democrat</td>
                                    <td id="inactive-democrat">-</td>
                                </tr>
                                <tr>
                                    <td>Republican</td>
                                    <td id="inactive-republican">-</td>
                                </tr>
                                <tr>
                                    <td>Green</td>
                                    <td id="inactive-green">-</td>
                                </tr>
                                <tr>
                                    <td>Libertarian</td>
                                    <td id="inactive-libertarian">-</td>
                                </tr>
                                <tr>
                                    <td>Unaffiliated</td>
                                    <td id="inactive-unaffiliated">-</td>
                                </tr>
                                <tr>
                                    <td>Other</td>
                                    <td id="inactive-other">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="comparison-view" style="display: none;">
            <h2>County Comparison</h2>

            <div class="comparison-container">
                <div class="comparison-county">
                    <h3 id="county1-name" class="county-header">County 1</h3>
                    <div class="chart-container">
                        <canvas id="county1-chart"></canvas>
                    </div>
                    <div class="chart-footer">
                        <div class="chart-source">Source: Maryland State Board of Elections</div>
                    </div>

                    <div class="data-tables">
                        <table class="display" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Democrat</th>
                                    <th>Republican</th>
                                    <th>Unaffiliated</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Official Turnout</td>
                                    <td id="county1-official-democrat">-</td>
                                    <td id="county1-official-republican">-</td>
                                    <td id="county1-official-unaffiliated">-</td>
                                </tr>
                                <tr>
                                    <td>Active Voters</td>
                                    <td id="county1-active-democrat">-</td>
                                    <td id="county1-active-republican">-</td>
                                    <td id="county1-active-unaffiliated">-</td>
                                </tr>
                                <tr>
                                    <td>Inactive Voters</td>
                                    <td id="county1-inactive-democrat">-</td>
                                    <td id="county1-inactive-republican">-</td>
                                    <td id="county1-inactive-unaffiliated">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="comparison-county">
                    <h3 id="county2-name" class="county-header">County 2</h3>
                    <div class="chart-container">
                        <canvas id="county2-chart"></canvas>
                    </div>
                    <div class="chart-footer">
                        <div class="chart-source">Source: Maryland State Board of Elections</div>
                    </div>

                    <div class="data-tables">
                        <table class="display" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Democrat</th>
                                    <th>Republican</th>
                                    <th>Unaffiliated</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Official Turnout</td>
                                    <td id="county2-official-democrat">-</td>
                                    <td id="county2-official-republican">-</td>
                                    <td id="county2-official-unaffiliated">-</td>
                                </tr>
                                <tr>
                                    <td>Active Voters</td>
                                    <td id="county2-active-democrat">-</td>
                                    <td id="county2-active-republican">-</td>
                                    <td id="county2-active-unaffiliated">-</td>
                                </tr>
                                <tr>
                                    <td>Inactive Voters</td>
                                    <td id="county2-inactive-democrat">-</td>
                                    <td id="county2-inactive-republican">-</td>
                                    <td id="county2-inactive-unaffiliated">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            console.log("Initializing dashboard");

            // Define chartColors and chartBorders using CNS color palette
            const chartColors = {
                democrat: 'rgba(25, 121, 185, 0.7)',     // CNS blue
                republican: 'rgba(199, 30, 29, 0.7)',    // CNS red
                green: 'rgba(143, 214, 148, 0.7)',       // CNS green
                libertarian: 'rgba(250, 169, 22, 0.7)',  // CNS orange
                unaffiliated: 'rgba(102, 102, 102, 0.7)',// CNS gray
                other: 'rgba(128, 33, 127, 0.7)',        // CNS purple
                statewide: 'rgba(10, 10, 10, 0.7)'       // CNS black
            };

            const chartBorders = {
                democrat: 'rgba(25, 121, 185, 1)',     // CNS blue
                republican: 'rgba(199, 30, 29, 1)',    // CNS red
                green: 'rgba(143, 214, 148, 1)',       // CNS green
                libertarian: 'rgba(250, 169, 22, 1)',  // CNS orange
                unaffiliated: 'rgba(102, 102, 102, 1)',// CNS gray
                other: 'rgba(128, 33, 127, 1)',        // CNS purple
                statewide: 'rgba(10, 10, 10, 1)'       // CNS black
            };

            const flaskDataElement = document.getElementById('flask-data');
            console.log("Flask Data Element:", flaskDataElement.dataset);

            window.officialTurnoutData = JSON.parse(flaskDataElement.dataset.official);
            window.activeVotersData = JSON.parse(flaskDataElement.dataset.active);
            window.inactiveVotersData = JSON.parse(flaskDataElement.dataset.inactive);
            window.counties = JSON.parse(flaskDataElement.dataset.counties);

            // Helper function to format numbers
            window.formatNumber = function (num) {
                if (num === null || num === undefined) return '-';

                // For percentages (small decimal numbers)
                if (Math.abs(num) < 10 && num.toString().includes('.')) {
                    return num > 0 ? `+${num}%` : `${num}%`;
                }

                // For larger numbers (voter counts)
                return num > 0 ? `+${num.toLocaleString()}` : num.toLocaleString();
            };

            // Helper function to safely update element text content
            const safelyUpdateElement = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = formatNumber(value);
                }
            };

            // Function to update charts
            function updateOverviewChart(data, county) {
                const canvasElement = document.getElementById('overview-chart');
                if (!canvasElement) {
                    console.error('Overview chart canvas element not found');
                    return;
                }

                const ctx = canvasElement.getContext('2d');
                if (!ctx) {
                    console.error('Could not get 2D context for overview chart');
                    return;
                }

                // Destroy existing chart if it exists
                if (window.overviewChart) {
                    window.overviewChart.destroy();
                }

                // CNS chart styling options - based on style guide
                const cnsChartOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false, // Per Flourish guideline - no legend
                        },
                        title: {
                            display: true,
                            text: `Voter turnout change in ${county} County`,
                            font: {
                                family: "'Source Serif Pro', serif",
                                size: 16
                            },
                            padding: {
                                bottom: 10
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `${context.label}: ${formatNumber(context.raw)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                drawBorder: false,
                            },
                            ticks: {
                                font: {
                                    family: "'Poppins', sans-serif"
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false // Per Flourish guideline - no grid lines
                            },
                            ticks: {
                                font: {
                                    family: "'Poppins', sans-serif"
                                },
                                // Per Flourish guideline - X-Axis Labels not angled
                                maxRotation: 0,
                                minRotation: 0
                            }
                        }
                    }
                };

                window.overviewChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Democrat', 'Republican', 'Green', 'Libertarian', 'Unaffiliated', 'Other', 'Total'],
                        datasets: [{
                            label: 'Change in Voter Turnout % (2020 → 2024)',
                            data: [
                                data.democrat_diff,
                                data.republican_diff,
                                data.green_diff,
                                data.libertarian_diff,
                                data.unaffiliated_diff,
                                data.other_diff,
                                data.statewide_diff
                            ],
                            backgroundColor: [
                                chartColors.democrat,
                                chartColors.republican,
                                chartColors.green,
                                chartColors.libertarian,
                                chartColors.unaffiliated,
                                chartColors.other,
                                chartColors.statewide
                            ],
                            borderColor: [
                                chartBorders.democrat,
                                chartBorders.republican,
                                chartBorders.green,
                                chartBorders.libertarian,
                                chartBorders.unaffiliated,
                                chartBorders.other,
                                chartBorders.statewide
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: cnsChartOptions
                });
            }

            function updateOfficialTurnoutChart(data, county) {
                const canvasElement = document.getElementById('official-turnout-chart');
                if (!canvasElement) return;

                const ctx = canvasElement.getContext('2d');
                if (!ctx) return;

                // Destroy existing chart if it exists
                if (window.officialTurnoutChart) {
                    window.officialTurnoutChart.destroy();
                }

                // CNS chart styling options
                const cnsChartOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false, // Per Flourish guideline
                        },
                        title: {
                            display: true,
                            text: `Official turnout change in ${county} County`,
                            font: {
                                family: "'Source Serif Pro', serif",
                                size: 16
                            },
                            padding: {
                                bottom: 10
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: {
                                drawBorder: false,
                            },
                            ticks: {
                                font: {
                                    family: "'Poppins', sans-serif"
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    family: "'Poppins', sans-serif"
                                },
                                maxRotation: 0,
                                minRotation: 0
                            }
                        }
                    }
                };

                window.officialTurnoutChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Democrat', 'Republican', 'Green', 'Libertarian', 'Unaffiliated', 'Other', 'Total'],
                        datasets: [{
                            label: 'Official Turnout Change % (2020 → 2024)',
                            data: [
                                data.democrat_diff,
                                data.republican_diff,
                                data.green_diff,
                                data.libertarian_diff,
                                data.unaffiliated_diff,
                                data.other_diff,
                                data.statewide_diff
                            ],
                            backgroundColor: [
                                chartColors.democrat,
                                chartColors.republican,
                                chartColors.green,
                                chartColors.libertarian,
                                chartColors.unaffiliated,
                                chartColors.other,
                                chartColors.statewide
                            ],
                            borderColor: [
                                chartBorders.democrat,
                                chartBorders.republican,
                                chartBorders.green,
                                chartBorders.libertarian,
                                chartBorders.unaffiliated,
                                chartBorders.other,
                                chartBorders.statewide
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: cnsChartOptions
                });
            }

            function updateActiveVotersChart(data, county) {
                const canvasElement = document.getElementById('active-voters-chart');
                if (!canvasElement) return;

                const ctx = canvasElement.getContext('2d');
                if (!ctx) return;

                // Destroy existing chart if it exists
                if (window.activeVotersChart) {
                    window.activeVotersChart.destroy();
                }

                // CNS chart styling options
                const cnsChartOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false, // Per Flourish guideline
                        },
                        title: {
                            display: true,
                            text: `Active voter change in ${county} County`,
                            font: {
                                family: "'Source Serif Pro', serif",
                                size: 16
                            },
                            padding: {
                                bottom: 10
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: {
                                drawBorder: false,
                            },
                            ticks: {
                                font: {
                                    family: "'Poppins', sans-serif"
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    family: "'Poppins', sans-serif"
                                },
                                maxRotation: 0,
                                minRotation: 0
                            }
                        }
                    }
                };

                window.activeVotersChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Democrat', 'Republican', 'Green', 'Libertarian', 'Unaffiliated', 'Other'],
                        datasets: [{
                            label: 'Change in Active Voters (2020 → 2024)',
                            data: [
                                data.democrat_diff,
                                data.republican_diff,
                                data.green_diff,
                                data.libertarian_diff,
                                data.unaffiliated_diff,
                                data.other_diff
                            ],
                            backgroundColor: [
                                chartColors.democrat,
                                chartColors.republican,
                                chartColors.green,
                                chartColors.libertarian,
                                chartColors.unaffiliated,
                                chartColors.other
                            ],
                            borderColor: [
                                chartBorders.democrat,
                                chartBorders.republican,
                                chartBorders.green,
                                chartBorders.libertarian,
                                chartBorders.unaffiliated,
                                chartBorders.other
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: cnsChartOptions
                });
            }

            function updateInactiveVotersChart(data, county) {
                const canvasElement = document.getElementById('inactive-voters-chart');
                if (!canvasElement) return;

                const ctx = canvasElement.getContext('2d');
                if (!ctx) return;

                // Destroy existing chart if it exists
                if (window.inactiveVotersChart) {
                    window.inactiveVotersChart.destroy();
                }

                // CNS chart styling options
                const cnsChartOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false, // Per Flourish guideline
                        },
                        title: {
                            display: true,
                            text: `Inactive voter change in ${county} County`,
                            font: {
                                family: "'Source Serif Pro', serif",
                                size: 16
                            },
                            padding: {
                                bottom: 10
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: {
                                drawBorder: false,
                            },
                            ticks: {
                                font: {
                                    family: "'Poppins', sans-serif"
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    family: "'Poppins', sans-serif"
                                },
                                maxRotation: 0,
                                minRotation: 0
                            }
                        }
                    }
                };

                window.inactiveVotersChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Democrat', 'Republican', 'Green', 'Libertarian', 'Unaffiliated', 'Other'],
                        datasets: [{
                            label: 'Change in Inactive Voters (2020 → 2024)',
                            data: [
                                data.democrat_diff,
                                data.republican_diff,
                                data.green_diff,
                                data.libertarian_diff,
                                data.unaffiliated_diff,
                                data.other_diff
                            ],
                            backgroundColor: [
                                chartColors.democrat,
                                chartColors.republican,
                                chartColors.green,
                                chartColors.libertarian,
                                chartColors.unaffiliated,
                                chartColors.other
                            ],
                            borderColor: [
                                chartBorders.democrat,
                                chartBorders.republican,
                                chartBorders.green,
                                chartBorders.libertarian,
                                chartBorders.unaffiliated,
                                chartBorders.other
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: cnsChartOptions
                });
            }

            function updateComparisonCharts(county1, county2) {
                // County 1 chart
                const county1Data = window.officialTurnoutData.find(item => item.county === county1);
                const canvas1 = document.getElementById('county1-chart');
                if (!canvas1) return;

                const ctx1 = canvas1.getContext('2d');
                if (!ctx1) return;

                if (window.county1Chart) {
                    window.county1Chart.destroy();
                }

                // CNS chart styling for comparison charts
                const cnsComparisonChartOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false, // Per Flourish guideline
                        },
                        title: {
                            display: true,
                            text: `${county1} County turnout change`,
                            font: {
                                family: "'Source Serif Pro', serif",
                                size: 16
                            },
                            padding: {
                                bottom: 10
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: {
                                drawBorder: false,
                            },
                            ticks: {
                                font: {
                                    family: "'Poppins', sans-serif"
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    family: "'Poppins', sans-serif"
                                },
                                maxRotation: 0,
                                minRotation: 0
                            }
                        }
                    }
                };

                window.county1Chart = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: ['Democrat', 'Republican', 'Unaffiliated'],
                        datasets: [{
                            label: 'Turnout Change %',
                            data: [
                                county1Data.democrat_diff,
                                county1Data.republican_diff,
                                county1Data.unaffiliated_diff
                            ],
                            backgroundColor: [
                                chartColors.democrat,
                                chartColors.republican,
                                chartColors.unaffiliated
                            ],
                            borderColor: [
                                chartBorders.democrat,
                                chartBorders.republican,
                                chartBorders.unaffiliated
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: cnsComparisonChartOptions
                });

                // County 2 chart
                const county2Data = window.officialTurnoutData.find(item => item.county === county2);
                const canvas2 = document.getElementById('county2-chart');
                if (!canvas2) return;

                const ctx2 = canvas2.getContext('2d');
                if (!ctx2) return;

                if (window.county2Chart) {
                    window.county2Chart.destroy();
                }

                // Clone the options and update the title for county2
                const county2Options = JSON.parse(JSON.stringify(cnsComparisonChartOptions));
                county2Options.plugins.title.text = `${county2} County turnout change`;

                window.county2Chart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: ['Democrat', 'Republican', 'Unaffiliated'],
                        datasets: [{
                            label: 'Turnout Change %',
                            data: [
                                county2Data.democrat_diff,
                                county2Data.republican_diff,
                                county2Data.unaffiliated_diff
                            ],
                            backgroundColor: [
                                chartColors.democrat,
                                chartColors.republican,
                                chartColors.unaffiliated
                            ],
                            borderColor: [
                                chartBorders.democrat,
                                chartBorders.republican,
                                chartBorders.unaffiliated
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: county2Options
                });
            }

            // Complete the updateSingleCountyView function
            window.updateSingleCountyView = function (county) {
                console.log("Updating view for county:", county);

                // Update the county header
                const countyNameHeader = document.getElementById('county-name-header');
                if (countyNameHeader) {
                    countyNameHeader.textContent = county;
                }

                // Find data for the selected county
                const officialData = window.officialTurnoutData.find(item => item.county === county) || {};
                const activeData = window.activeVotersData.find(item => item.county === county) || {};
                const inactiveData = window.inactiveVotersData.find(item => item.county === county) || {};

                // Update overview tab elements
                safelyUpdateElement('total-turnout-change', officialData.statewide_diff);
                safelyUpdateElement('democrat-turnout-change', officialData.democrat_diff);
                safelyUpdateElement('republican-turnout-change', officialData.republican_diff);
                safelyUpdateElement('unaffiliated-turnout-change', officialData.unaffiliated_diff);

                // Update official turnout tab elements
                safelyUpdateElement('official-democrat', officialData.democrat_diff);
                safelyUpdateElement('official-republican', officialData.republican_diff);
                safelyUpdateElement('official-green', officialData.green_diff);
                safelyUpdateElement('official-libertarian', officialData.libertarian_diff);
                safelyUpdateElement('official-unaffiliated', officialData.unaffiliated_diff);
                safelyUpdateElement('official-other', officialData.other_diff);
                safelyUpdateElement('official-statewide', officialData.statewide_diff);

                // Update active voters tab elements
                safelyUpdateElement('active-democrat', activeData.democrat_diff);
                safelyUpdateElement('active-republican', activeData.republican_diff);
                safelyUpdateElement('active-green', activeData.green_diff);
                safelyUpdateElement('active-libertarian', activeData.libertarian_diff);
                safelyUpdateElement('active-unaffiliated', activeData.unaffiliated_diff);
                safelyUpdateElement('active-other', activeData.other_diff);

                // Update inactive voters tab elements
                safelyUpdateElement('inactive-democrat', inactiveData.democrat_diff);
                safelyUpdateElement('inactive-republican', inactiveData.republican_diff);
                safelyUpdateElement('inactive-green', inactiveData.green_diff);
                safelyUpdateElement('inactive-libertarian', inactiveData.libertarian_diff);
                safelyUpdateElement('inactive-unaffiliated', inactiveData.unaffiliated_diff);
                safelyUpdateElement('inactive-other', inactiveData.other_diff);

                // Update the charts - safely check if canvas elements exist first
                updateOverviewChart(officialData, county);
                updateOfficialTurnoutChart(officialData, county);
                updateActiveVotersChart(activeData, county);
                updateInactiveVotersChart(inactiveData, county);
            };

            // Function to update the comparison view
            window.updateComparisonView = function (county1, county2) {
                // Show comparison view, hide single county view
                document.getElementById('single-county-view').style.display = 'none';
                document.getElementById('comparison-view').style.display = 'block';

                // Set county names in headers
                document.getElementById('county1-name').textContent = county1;
                document.getElementById('county2-name').textContent = county2;

                // Find data for both counties
                const county1OfficialData = window.officialTurnoutData.find(item => item.county === county1) || {};
                const county1ActiveData = window.activeVotersData.find(item => item.county === county1) || {};
                const county1InactiveData = window.inactiveVotersData.find(item => item.county === county1) || {};

                const county2OfficialData = window.officialTurnoutData.find(item => item.county === county2) || {};
                const county2ActiveData = window.activeVotersData.find(item => item.county === county2) || {};
                const county2InactiveData = window.inactiveVotersData.find(item => item.county === county2) || {};

                // Update county 1 data cells
                safelyUpdateElement('county1-official-democrat', county1OfficialData.democrat_diff);
                safelyUpdateElement('county1-official-republican', county1OfficialData.republican_diff);
                safelyUpdateElement('county1-official-unaffiliated', county1OfficialData.unaffiliated_diff);

                safelyUpdateElement('county1-active-democrat', county1ActiveData.democrat_diff);
                safelyUpdateElement('county1-active-republican', county1ActiveData.republican_diff);
                safelyUpdateElement('county1-active-unaffiliated', county1ActiveData.unaffiliated_diff);

                safelyUpdateElement('county1-inactive-democrat', county1InactiveData.democrat_diff);
                safelyUpdateElement('county1-inactive-republican', county1InactiveData.republican_diff);
                safelyUpdateElement('county1-inactive-unaffiliated', county1InactiveData.unaffiliated_diff);

                // Update county 2 data cells
                safelyUpdateElement('county2-official-democrat', county2OfficialData.democrat_diff);
                safelyUpdateElement('county2-official-republican', county2OfficialData.republican_diff);
                safelyUpdateElement('county2-official-unaffiliated', county2OfficialData.unaffiliated_diff);

                safelyUpdateElement('county2-active-democrat', county2ActiveData.democrat_diff);
                safelyUpdateElement('county2-active-republican', county2ActiveData.republican_diff);
                safelyUpdateElement('county2-active-unaffiliated', county2ActiveData.unaffiliated_diff);

                safelyUpdateElement('county2-inactive-democrat', county2InactiveData.democrat_diff);
                safelyUpdateElement('county2-inactive-republican', county2InactiveData.republican_diff);
                safelyUpdateElement('county2-inactive-unaffiliated', county2InactiveData.unaffiliated_diff);

                // Update comparison charts
                updateComparisonCharts(county1, county2);
            };

            // Set up sidebar navigation
            window.openNav = function () {
                document.getElementById("mySidenav").style.width = "250px";
            };

            window.closeNav = function () {
                document.getElementById("mySidenav").style.width = "0";
            };

            // Populate dropdown menus
            const primarySelect = document.getElementById('primary-county-select');
            const comparisonSelect = document.getElementById('comparison-county-select');

            // Clear existing options
            primarySelect.innerHTML = '<option value="">Select County</option>';
            comparisonSelect.innerHTML = '<option value="">Select County</option>';

            // Add counties to dropdowns
            window.counties.forEach(county => {
                const primaryOption = document.createElement('option');
                primaryOption.value = county;
                primaryOption.textContent = county;
                primarySelect.appendChild(primaryOption);

                const comparisonOption = document.createElement('option');
                comparisonOption.value = county;
                comparisonOption.textContent = county;
                comparisonSelect.appendChild(comparisonOption);
            });

            // Set up event listeners

            // Primary county selection
            primarySelect.addEventListener('change', function () {
                const selectedCounty = this.value;
                if (selectedCounty) {
                    updateSingleCountyView(selectedCounty);

                    // If we're in comparison mode and have a second county selected
                    const comparisonCounty = comparisonSelect.value;
                    if (document.getElementById('comparison-view').style.display === 'block' && comparisonCounty) {
                        updateComparisonView(selectedCounty, comparisonCounty);
                    } else {
                        // Otherwise, make sure we're in single county view
                        document.getElementById('single-county-view').style.display = 'block';
                        document.getElementById('comparison-view').style.display = 'none';
                    }
                }
            });

            // Comparison county selection
            comparisonSelect.addEventListener('change', function () {
                const selectedCounty = this.value;
                const primaryCounty = primarySelect.value;

                if (selectedCounty && primaryCounty) {
                    updateComparisonView(primaryCounty, selectedCounty);
                }
            });

            // Enable comparison button
            document.getElementById('enable-comparison-btn').addEventListener('click', function () {
                document.getElementById('comparison-controls').style.display = 'block';
                this.style.display = 'none';
                document.getElementById('disable-comparison-btn').style.display = 'inline-block';
            });

            // Disable comparison button
            document.getElementById('disable-comparison-btn').addEventListener('click', function () {
                document.getElementById('comparison-controls').style.display = 'none';
                this.style.display = 'none';
                document.getElementById('enable-comparison-btn').style.display = 'inline-block';

                // Switch back to single county view
                document.getElementById('single-county-view').style.display = 'block';
                document.getElementById('comparison-view').style.display = 'none';

                // Reset comparison dropdown
                comparisonSelect.value = '';

                // Refresh the single county view with currently selected county
                const selectedCounty = primarySelect.value;
                if (selectedCounty) {
                    updateSingleCountyView(selectedCounty);
                }
            });

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    // Remove active class from all tabs
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    // Add active class to clicked tab
                    this.classList.add('active');

                    // Hide all tab content
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                    // Show relevant tab content
                    const tabName = this.getAttribute('data-tab');
                    document.getElementById(tabName).classList.add('active');
                });
            });

            // Initialize with the first county
            if (window.counties && window.counties.length > 0) {
                primarySelect.value = window.counties[0];
                updateSingleCountyView(window.counties[0]);
            }

            // Initialize DataTables
            $(document).ready(function () {
                $('#official-turnout-table').DataTable({
                    paging: false,
                    searching: false,
                    info: false
                });

                $('#active-voters-table').DataTable({
                    paging: false,
                    searching: false,
                    info: false
                });

                $('#inactive-voters-table').DataTable({
                    paging: false,
                    searching: false,
                    info: false
                });
            });

            console.log("Dashboard initialization complete according to CNS style guide");
        });
    </script>
</body>

</html>