<!doctype html>
<html lang="en">
    <head>
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
        <link rel="stylesheet" href="/static/general_style.css">
        <link rel="stylesheet" href="/static/official_turnout.css">
        <link rel="stylesheet" href="//cdn.datatables.net/2.0.0/css/dataTables.dataTables.min.css"/>
        <script src="//cdn.datatables.net/2.0.0/js/dataTables.min.js"></script>
    </head>
    <body>
        <span style="font-size:30px;cursor:pointer" onclick="openNav()">&#9776; Menu</span>
        
        <div id="mySidenav" class="sidenav">
            <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
            <a href="#">Home</a>
            <a href="official-turnout">Official Maryland Turnout</a>
            <a href="eligible-active">Eligible Active Voters</a>
            <a href="eligible-inactive">Eligible Inactive Voters</a>
        </div>
        
        <h1>Maryland Voter Turnout Data</h1>
        
        <div class="controls">
            
            <div class="filter-group">
                <label for="county-filter">Filter by County:</label>
                <select id="county-filter">
                    <option value="all">All Counties</option>
                    <!-- Counties will be populated via JavaScript -->
                </select>
            </div>
            
            <button id="reset-filters">Reset Filters</button>
        </div>

        <table id="voter-data" border=1 cellpadding=7>
            <thead>
                <tr>
                    <th>County</th>
                    <th>Statewide</th>
                    <th>Democrat</th>
                    <th>Republican</th>
                    <th>Green</th>
                    <th>Libertarian</th>
                    <th>Unaffiliated</th>
                    <th>Other</th>    
                </tr>
            </thead>
            <tbody>
                {% for obj in object_list %}
                <tr>
                    <td>{{ obj.county }}</td>
                    <td>{{ "{:,}".format(obj.statewide_diff) }}</td>
                    <td>{{ "{:,}".format(obj.democrat_diff) }}</td>
                    <td>{{ "{:,}".format(obj.republican_diff) }}</td>
                    <td>{{ "{:,}".format(obj.green_diff) }}</td>
                    <td>{{ "{:,}".format(obj.libertarian_diff) }}</td>
                    <td>{{ "{:,}".format(obj.unaffiliated_diff) }}</td>
                    <td>{{ "{:,}".format(obj.other_diff) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <script type="text/javascript">
            $('#voter-data').DataTable({
                paging: true,
                searching: false,
                autoWidth: false,
                columnDefs: [
                    { targets: 'no-sort', orderable: false }
                ]
            });
        </script>

        <script>
            function openNav() {
              document.getElementById("mySidenav").style.width = "250px";
            }
            
            function closeNav() {
              document.getElementById("mySidenav").style.width = "0";
            }

            document.addEventListener('DOMContentLoaded', function() {
                const table = $('#voter-data').DataTable(); // Get the DataTable instance

                const countyFilter = document.getElementById('county-filter');
                const yearFilter = document.getElementById('year-filter');
                const partyFilter = document.getElementById('party-filter');
                const resetButton = document.getElementById('reset-filters');

                // Get unique county names and populate the dropdown
                const uniqueCounties = new Set();
                table.rows().every(function () {
                    const data = this.data();
                    uniqueCounties.add(data[0]); // County is in column index 0
                });

                Array.from(uniqueCounties).sort().forEach(county => {
                    const opt = document.createElement('option');
                    opt.value = county;
                    opt.textContent = county;
                    countyFilter.appendChild(opt);
                });

                // Filter function
                function applyFilters() {
                    const year = yearFilter.value;
                    const county = countyFilter.value;
                    const party = partyFilter.value;

                    table.rows().every(function () {
                        const data = this.data();

                        const showRow =
                            (year === 'all' || data[8] == year) && // Year is column index 8
                            (county === 'all' || data[0] == county) && // County index 0
                            (party === 'none' || data[7] == party); // Party index 7

                        if (showRow) {
                            $(this.node()).show();
                        } else {
                            $(this.node()).hide();
                        }
                    });
                }

                // Attach change listeners
                yearFilter.addEventListener('change', applyFilters);
                countyFilter.addEventListener('change', applyFilters);
                partyFilter.addEventListener('change', applyFilters);

                // Reset button
                resetButton.addEventListener('click', () => {
                    yearFilter.value = 'all';
                    countyFilter.value = 'all';
                    partyFilter.value = 'none';
                    applyFilters();
                });

                // Apply once on load
                applyFilters();
            });
        </script>
    </body>
</html>