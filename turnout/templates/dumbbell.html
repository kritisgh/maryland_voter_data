<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dumbbell Chart — Turnout Change 2020→2024</title>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chart.js Annotation Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #controls { margin-bottom: 10px; }
    canvas { max-width: 100%; height: 600px; }
  </style>
</head>
<body>
  <div id="controls">
    <label for="partySelect">Select Party:</label>
    <select id="partySelect"></select>
  </div>
  <canvas id="dumbbellChart"></canvas>

  <script>
    const csvFile = "{{ url_for('static', filename='official_by_party_and_county_complete.csv') }}";
    let rawData, chartInstance;

    async function loadData() {
      return new Promise(resolve => {
        Papa.parse(csvFile, {
          download: true,
          header: true,
          complete: results => resolve(results.data)
        });
      });
    }

    function prepareData(party) {
      const rows = rawData.filter(r => r.Party === party);
      const byCounty = {};
      rows.forEach(r => {
        const pct = parseFloat(r['Turnout Percentage']);
        if (!byCounty[r.County]) byCounty[r.County] = {};
        byCounty[r.County][r.Year] = pct;
      });

      const increased = [], decreased = [];
      Object.entries(byCounty).forEach(([county, years]) => {
        if (years['2020'] != null && years['2024'] != null) {
          const diff = years['2024'] - years['2020'];
          if (diff >= 0) increased.push({ county, diff });
          else decreased.push({ county, diff });
        }
      });

      increased.sort((a, b) => b.diff - a.diff);
      decreased.sort((a, b) => a.diff - b.diff);

      const sortedIncr = increased.map(d => d.county);
      const sortedDecr = decreased.map(d => d.county);
      const counties = [...sortedIncr, ...sortedDecr];
      const data2020 = counties.map(c => byCounty[c]['2020']);
      const data2024 = counties.map(c => byCounty[c]['2024']);

      return {
        counties,
        data2020,
        data2024,
        dividingIndex: sortedIncr.length
      };
    }

    function updateChart(party) {
      const { counties, data2020, data2024, dividingIndex } = prepareData(party);

      const lineDatasets = counties.map((county, i) => ({
        type: 'line',
        label: '',
        data: [
          { x: data2020[i], y: county },
          { x: data2024[i], y: county }
        ],
        borderColor: 'gray',
        borderWidth: 1.5,
        pointRadius: 0,
        fill: false,
        showLine: true
      }));

      const scatter2020 = counties.map((county, i) => ({ x: data2020[i], y: county }));
      const scatter2024 = counties.map((county, i) => ({ x: data2024[i], y: county }));

      chartInstance.data.labels = counties;

      chartInstance.data.datasets = [
        ...lineDatasets,
        {
          label: '2020',
          type: 'scatter',
          data: scatter2020,
          backgroundColor: 'steelblue',
          pointRadius: 6,
          tooltip: {
            callbacks: { label: ctx => `2020: ${ctx.raw.x.toFixed(1)}%` }
          }
        },
        {
          label: '2024',
          type: 'scatter',
          data: scatter2024,
          backgroundColor: 'lightsteelblue',
          pointRadius: 6,
          tooltip: {
            callbacks: { label: ctx => `2024: ${ctx.raw.x.toFixed(1)}%` }
          }
        }
      ];

      chartInstance.options.plugins.annotation = {
        annotations: {
          dividingLine: {
            type: 'line',
            scaleID: 'y',
            value: counties[dividingIndex],
            borderColor: 'red',
            borderWidth: 2,
            label: {
              enabled: true,
              content: 'Turnout Decreased',
              position: 'start'
            }
          }
        }
      };

      chartInstance.update();
    }

    function populatePartySelect(parties) {
      const sel = document.getElementById('partySelect');
      parties.forEach(p => sel.appendChild(new Option(p, p)));
      sel.addEventListener('change', () => updateChart(sel.value));
      return parties[0];
    }

    async function init() {
      rawData = await loadData();
      const parties = Array.from(new Set(rawData.map(r => r.Party))).sort();
      const defaultParty = populatePartySelect(parties);

      const ctx = document.getElementById('dumbbellChart').getContext('2d');
      chartInstance = new Chart(ctx, {
        data: { labels: [], datasets: [] },
        options: {
          indexAxis: 'y',
          scales: {
            x: {
              type: 'linear',
              min: 50,
              max: 100,
              title: { display: true, text: 'Turnout %' }
            },
            y: {
              type: 'category',
              offset: true,
              title: { display: true, text: 'County' }
            }
          },
          plugins: {
            legend: {
              labels: {
                filter: item => ['2020', '2024'].includes(item.text)
              }
            },
            annotation: {}
          }
        }
      });

      updateChart(defaultParty);
    }

    init();
  </script>
</body>
</html>
