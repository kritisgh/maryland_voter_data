<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maryland 2024 Election: Map and Detailed Tooltip Chart</title>
    <!-- Include required styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>
    <!-- Include static js, Chart.js and D3.js -->
    <script src="static/script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- For Datawrapper events -->
    <script src="//static.dwcdn.net/js/events.js"></script>
    <script type="text/javascript">
      // Global variable: default party selection for the map.
      let chartId = 'YcZmw';
    </script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        max-width: 1000px;
        margin: 0 auto;
        text-align: center;
        overflow-y: auto;
      }
      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      /* Fix the map container height and hide overflow */
      .map {
        width: 80%;
        overflow: hidden;
        margin: 0 auto 30px;
        position: relative;
      }
      /* Force the iframe to match the container height */
      .map iframe {
        width: 100%;
        height: 500px !important;
        margin: 0;
        border: none;
      }
      select {
        padding: 8px;
        font-size: 16px;
        border-radius: 4px;
        width: 300px;
        margin-bottom: 20px;
      }
      h1 {
        color: #333;
      }
      /* Modified tooltip styling: increased size and space for the integrated chart */
      .tooltip {
        background: #fff;
        border: 1px solid #ccc;
        padding: 20px;
        border-radius: 4px;
        margin: 20px auto;
        cursor: pointer;
        width: 80%;
        max-width: 700px;
        min-height: 500px;
      }
      /* Center the SVG element inside the chart placeholder */
      #tooltipChart svg {
        display: block;
        margin: 0 auto;
      }
      /* D3 chart text labels styling */
      .bar text {
        fill: white;
        font: 10px sans-serif;
        text-anchor: middle;
      }
    </style>
  </head>
  <body>
    <h1>Who Voted in the 2024 Election in Maryland?</h1>
    <div class="container">
      <div class="map" id="map">
        <h3>Select Party:</h3>
        <select onchange="switchVis(this.value)">
          <option value="YcZmw">Democrats</option>
          <option value="xElgG">Republicans</option>
          <option value="nuu3A">Unaffiliated</option>
        </select>
        <iframe title="Maryland Counties Map" id="datawrapper-chart-YcZmw" src="https://datawrapper.dwcdn.net/YcZmw/1/" scrolling="no" frameborder="0" data-external="1"></iframe>
      </div>
      <!-- Integrated tooltip: this will expand to show county info plus the chart -->
      <div class="tooltip" id="tooltip">
        <!-- 1) Header area we’ll overwrite on hover or select -->
        <div id="tooltipHeader">
          <p>Hover over a county on the map to see details here, or use the county dropdown below!</p>
        </div>
        <div id="tooltipDropdown">
          <p>Select a County</p>
          <select id="county-dropdown">
            <option value="">-- Select County --</option>
            {% for county in counties %}
              <option value="{{ county }}">{{ county }}</option>
            {% endfor %}
          </select>
          <div id="tooltipChart" style="margin-top:20px;"></div>
        </div>
      </div>
      
    </div>
    
    <script>
      // Global variables to track current county and debounce.
      let currentCounty = "";
      let lastCounty = "";
      let debounceTimeout;
      
      // Select the tooltip element.
      const tooltip = document.getElementById('tooltip');
      
      datawrapper.on('region.mouseenter', ({data}) => {
  function formatCountyName(name) {
    return (name === "Baltimore City" || name === "Baltimore County")
      ? name
      : name + " County";
  }
  const newCounty = data.id || data.County;
  if (newCounty === lastCounty) return;
  lastCounty = newCounty;

  // Build just the header
  let headerHTML = `<h3>${formatCountyName(newCounty)}</h3>`;
  if (chartId === 'YcZmw') {
    headerHTML += `<p>Democratic Turnout: ${((data.value||data.DEM)||0).toFixed(2)}%</p>`;
  } else if (chartId === 'xElgG') {
    headerHTML += `<p>Republican Turnout: ${((data.value||data.REP)||0).toFixed(2)}%</p>`;
  } else {
    headerHTML += `<p>Unaffiliated Turnout: ${((data.value||data.UNA)||0).toFixed(2)}%</p>`;
  }

  // Only overwrite the header div
  document.getElementById('tooltipHeader').innerHTML = headerHTML;
  const dropdown = document.getElementById('county-dropdown');
  dropdown.value = newCounty;
  // optionally fire its change handler so you don’t duplicate updateChart calls:
  dropdown.dispatchEvent(new Event('change'));

  // Debounce & redraw the chart
  if (debounceTimeout) clearTimeout(debounceTimeout);
  debounceTimeout = setTimeout(() => updateChart(newCounty), 0);
});

document.getElementById('county-dropdown')
  .addEventListener('change', function() {
    const selected = this.value;
    if (!selected) return;

    function formatCountyName(name) {
          return (name === "Baltimore City" || name === "Baltimore County") ? name : name + " County";
        }
    // Overwrite header with just the county name
    document.getElementById('tooltipHeader').innerHTML = `<h3>${formatCountyName(selected)}</h3>`;

    // Fetch & draw
    updateChart(selected);
  });

      // -- D3.js CHART CODE --
      // (Note: The chart will now be drawn into the #tooltipChart container.)
      const margin = {top: 40, right: 20, bottom: 40, left: 40};
      const width = 700 - margin.left - margin.right;
      const height = 400 - margin.top - margin.bottom;
      
      const colorMap = {
        "Democrats": "rgba(0, 126, 167)",
        "Republicans": "rgba(200, 30, 30)",
        "Unaffiliated": "rgba(250, 140, 1)",
        "Other": "rgba(203, 202, 202)"
      };
      
      // Modified drawChart: Draws the chart inside #tooltipChart and adds a title with the county name.
      function drawChart(data, county) {
        function formatCountyName(name) {
          return (name === "Baltimore City" || name === "Baltimore County") ? name : name + " County";
        }
        
        const barsData = data.ages.map((age, i) => ({
          age: age,
          segments: [
            { party: "Democrats", value: data.dem[i] },
            { party: "Republicans", value: data.rep[i] },
            { party: "Unaffiliated", value: data.unaffiliated[i] },
            { party: "Other", value: data.other[i] }
          ]
        }));
        
        // Sort segments so that the largest is drawn last.
        barsData.forEach(d => {
          d.segments.sort((a, b) => a.value - b.value);
        });
        
        // Remove any previous SVG content in the tooltip chart placeholder.
        d3.select("#tooltipChart").select("svg").remove();
        
        const svg = d3.select("#tooltipChart")
                      .append("svg")
                      .attr("width", width + margin.left + margin.right)
                      .attr("height", height + margin.top + margin.bottom)
                      .append("g")
                      .attr("transform", `translate(${margin.left},${margin.top})`);
        
        const x = d3.scaleBand()
                    .domain(barsData.map(d => d.age))
                    .range([0, width])
                    .padding(0.2);
        
        const y = d3.scaleLinear()
                    .domain([0, 100])
                    .range([height, 0]);
        
        svg.append("g")
           .attr("transform", `translate(0, ${height})`)
           .call(d3.axisBottom(x));
        
        svg.append("g")
           .call(d3.axisLeft(y));
        
        barsData.forEach(d => {
          let cumulative = 0;
          const g = svg.append("g")
                       .attr("class", "bar")
                       .attr("transform", `translate(${x(d.age)},0)`);
          
          d.segments.forEach(segment => {
            const y0 = y(cumulative);
            cumulative += segment.value;
            const y1 = y(cumulative);
            const barHeight = y0 - y1;
            
            g.append("rect")
             .attr("x", 0)
             .attr("y", y1)
             .attr("width", x.bandwidth())
             .attr("height", barHeight)
             .attr("fill", colorMap[segment.party]);
            
            if (barHeight > 15) {
              g.append("text")
               .attr("x", x.bandwidth() / 2)
               .attr("y", y1 + barHeight / 2)
               .attr("dy", "0.35em")
               .attr("fill", "white")
               .attr("font-size", "9px")
               .text(segment.party + " (" + segment.value.toFixed(1) + "%)");
            }
          });
        });
        
        svg.append("text")
           .attr("x", width / 2)
           .attr("y", -10)
           .attr("text-anchor", "middle")
           .attr("font-size", "16px")
           .attr("fill", "black")
           .text("2024 Vote Percentages by Party Affiliation and Age for " + formatCountyName(county));
      }
      
      // updateChart fetches data for the county and calls drawChart.
      function updateChart(county) {
        fetch('/data/' + encodeURIComponent(county))
          .then(response => response.json())
          .then(data => drawChart(data, county))
          .catch(err => console.error(err));
      }
    </script>
  </body>
</html>
